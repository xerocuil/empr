{% extends 'library/base.html' %}

{% block content %}

<h2>
    <a href="{{ url_for('device.detail', device_slug=device['slug']) }}">{% block title %}{{ device['name'] }}  / {{ platform.name }}{% endblock %}</a>
</h2>

<article id="device">
    <div id="installed">
        <h3>Installed Games</h3>
        <div class="listing">
            <table>
                {% for g in device_games %}
                    <tr>
                        <td>
                            {% if g.title %}
                                {{ g.title }}
                            {% else %}
                                {{ g.filename}}
                            {% endif %}
                        </td>

                        <td>
                            <button onclick="uninstallGame('{{ device.slug }}', '{{ platform.slug }}', '{{ g.filename }}')">DEL</button>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <div id="available">
        <h3>Available Games</h3>
        <div class="listing">
            <table>
                {% for ag in available_games %}
                    <tr>
                        <td>{{ ag.title }}</td>
                        <td><button onclick="installGame('{{ device.slug }}', '{{ platform.slug }}', '{{ ag.filename }}')">Install</button></td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</article>

<div id="console" style="display: none;">
    <div id="console-container">
        <p id="console-text"></p>

        <div id="console-confirm" style="display: none;"><button onclick="window.location.reload();">OK</button></div>
        <button onclick="hideConsole()">Close Window</button>
    </div>
</div>

<script type="text/javascript">
    function showConsole(response) {
        const consoleDiv = document.getElementById("console");
        let message  = document.getElementById("console-text")
        message.innerText = '';
        message.innerText = response.message;
        consoleDiv.style.display = "block";
    }

    function hideConsole() {
        document.getElementById("console").style.display = "none";
    }

    function toggleConsole() {
        var divStatus = document.getElementById("console").style.display
        if (divStatus == "block"){
            hideConsole();
        } else if (divStatus == "none"){
            showConsole();
        }
    }

    function installGame(device_slug, platform, filename) {
        let message = {"message":"Installing "+filename+" ..."}
        const confirmDiv = document.getElementById("console-confirm")
        showConsole(message);
        pywebview.api.install_game(device_slug, platform, filename)
            .then(showConsole)
            .then(confirmDiv.style.display = "block");
    }

    function uninstallGame(device_slug, platform_slug, filename) {
        let test = window.confirm(`Are you sure you want to remove ${filename}?`);
        if (test == true){
            pywebview.api.uninstall_game(device_slug, platform_slug, filename)
            window.alert(`${filename} has been removed.`)
            window.location.reload()
        }
        
    }
</script>
{% endblock %}


{% block sidebar %}
    

{% endblock %}

